#include <iostream>
#include <ncurses/ncurses.h>

using namespace std;

// Helper function algorithem
// Mengembalikan nilai terbesar antara a dan b
int max(int a, int b) {
    return (a > b) ? a : b;
}

// Definisikan pasangan warna
enum ColorPairs {
    PAIR_BORDER = 1,
    PAIR_WALL = 2,
    PAIR_PATH = 3,
    PAIR_START_END = 4,
    PAIR_PLAYER = 5,
    PAIR_MENU = 6,
    PAIR_INFO = 7,
    PAIR_WIN = 8
};

// Konstanta Ukuran Labirin
const int MAZE_ROWS = 25;
const int MAZE_COLS = 51;

// Struktur posisi
struct Position {
    int row;
    int col;
};

// =============================================================
//  MAZE VERY EASY (Ukuran 25x50)
// =============================================================
char mazeVeryEasy[MAZE_ROWS][MAZE_COLS] = {
"##################################################",
"##  S                                  ##       ##",
"## ######################### ######### ## ########",
"##                        ## ##   ##   ## ##    ##",
"######################### ## ##   ##   ## ##    ##",
"##                     ## ## ##   ##   ## ##    ##",
"## ###################### ## ##   ##   ## ##    ##",
"##   ##                   ## ##   ####### ##    ##",
"## #########################      ##      ##### ##",
"##                                              ##",
"## ###############################################",
"##   ##                                         ##",
"##   ## #### ############################## ######",
"##   ##   ##       ##                 ##    ##  ##",
"##   ##   ##       ##                 ##        ##",
"##   ############# ## #### ############# #########",
"##   ##            ##  ##  ##            ##     ##",
"##   ########      ######  ##         ######### ##",
"##         ##      ##  ##  ## #####   ##        ##",
"##      ## ##      ##  ##  ##    ##   ##        ##",
"########## ##      ## #### ##    ##   ##        ##",
"##         ##      ##      ##    ######## ##### ##",
"## ############### ##########    ##       ##    ##",
"##                         ##             ## F  ##",
"##################################################",
};

// =============================================================
//  MAZE EASY (Ukuran 25x50)
// =============================================================
char mazeEasy[MAZE_ROWS][MAZE_COLS] = {
"##################################################",
"##  ##             ##                           ##",
"##     ## ########### ################ ######## ##",
"######### ##          ##      ##       ##       ##",
"##     ## ####### ############## ######## ########",
"## ##  ##    ##       ##         ##       ##    ##",
"## ######### ## ############# ##### ##### ########",
"## ##           ##            ## ## ##    ##    ##",
"## ############ ############# ## ## ##    ##    ##",
"##    ##         ##              ## ##    ##    ##",
"##### ########## ################## ## #####    ##",
"##        ##  ## ##              ## ##          ##",
"## #####  ##  ## ######## ######### ##    ##    ##",
"##    ##  ##  ## ##    ## ##     ##### ## ########",
"##### ##  ##  ## ##    ## ##           ##       ##",
"##    ##  ##  ## ##    ## ############ ##       ##",
"## #####  ###### ##        ##   F   ## ##       ##",
"## ##     ##     ######### ######## ## ###########",
"## S         ######     ## ##    ## ##          ##",
"## ######### ##         ## ##### ## ## ## ########",
"## ##  ##    ## ######           ## ## ## ##    ##",
"## ##  ## ##### ##  ############### ## ## #### ###",
"##     ##    ##                        ##       ##",
"##     ##    ##                        ##       ##",
"##################################################",
};

// =============================================================
//  MAZE MEDIUM (Ukuran 25x50)
// =============================================================
char mazeMedium[MAZE_ROWS][MAZE_COLS] = {
"##################################################",
"##          ##                                  ##",
"##          ## ################################ ##",
"## ########### ##          ##  ##  ##        ## ##",
"##                         ##  ##  ######### ## ##",
"######################## ####  ##  ##        ## ##",
"##                    ##   ##  ##  ##        ## ##",
"##                    ##  F##  ##  ######### ## ##",
"##################### ####### #### ##        ## ##",
"##    ##           ##              ##           ##",
"##    ## ####      ##### ###################### ##",
"##    ##   ## ####    ##           ##           ##",
"########   ##   ##    ##           ######       ##",
"##         ##   ##    ##               ###### ####",
"##         ##   ##    ##               ##       ##",
"##### ############### ## ### ############  #######",
"##    ##           ## ##  ## ##        ##       ##",
"##    ########     ## ##  ## ##        ######## ##",
"##    ##    ##     ## ##  ## ## ####   ##       ##",
"##    ##    ##     ## ##  ## ##   ##   ##  ##   ##",
"##### ##### ##     ## ###### ##   ##   ##  ##   ##",
"##  S       ##     ##        ##   ######## ##   ##",
"##### ################ ########   ##       ##   ##",
"##                  ##                     ##   ##",
"##################################################",
};

// =============================================================
//  MAZE HARD (Ukuran 25x50)
// =============================================================
char mazeHard[MAZE_ROWS][MAZE_COLS] = {
    "#################################################",
    "#S                                   #         F#",
    "#  ###########################  ######  ######  #",
    "#          #                 #      ##          #",
    "#  ###  #  #  #  ##########  #####  ##  #  ###  #",
    "#    #  #     #  #  ####     #      #####    #  #",
    "######  #######  #     #  ####  #####     ####  #",
    "#             #  ####  #     #      #  ####     #",
    "#  ############  #     ####  #####  #     #  ####",
    "#   #     #   #  #  ####     #      ####  #     #",
    "#  ##  #  #   #  #     ####  #  #####     ####  #",
    "#      #      #              #      #  #  #     #",
    "###############  #################  #  ####  ####",
    "#             #          #          ####        #",
    "#  #  ######  #########  #  ######  #     ####  #",
    "####  #           #      #      #####  ####     #",
    "#     #  #######  #  #########  #      #     ####",
    "#  ####     #     #          #  #  #####  #     #",
    "#     ####  #  #  #  ######  #  #      #  ####  #",
    "####  #        #  #      ##     #####  #  #     #",
    "#  #  #  #######  #####  ########      #  #  ####",
    "#     #                  #         #####  #     #",
    "#  ################  #########################  #",
    "#                                               #",
    "#################################################"
};

// =============================================================
//  MAZE VERY HARD (Ukuran 25x50)
// =============================================================
char mazeVeryHard[MAZE_ROWS][MAZE_COLS] = {
    "#################################################",
    "#              S                    #      #    #",
    "#  ##################  #######  #####   #       #",
    "#          #                 #      #   ######  #",
    "#  ###  #  #  #  ##########  #####  #        #  #",
    "#    #  #     #  #  ####     #      #####    #  #",
    "######  #######  #     #  ####  #####  #F  ###  #",
    "#             #  ####  #     #      #  ####     #",
    "#  ############  #     ####  #####  #     #  ####",
    "#   #     #      #  ####     #      ####  #     #",
    "#  ##  #  #   ####  #  ####  #  #####     ####  #",
    "#      #      #              #      #  #        #",
    "###############  #################  #  #  #  ####",
    "#                #       #          ####  #     #",
    "#  #  ######  #########  ########   #     ####  #",
    "####  #       #   #      #      #####  ####  #  #",
    "#        #######  #  ######  #  #   #        ####",
    "#  ####     #     #          #  #  #####  #     #",
    "#     ####  #  ####  #########  #      #  ####  #",
    "####  #        #      #  #      #####  #  #     #",
    "#  #  #  #######  #####  #####  #      #  #  ####",
    "#     #           #      #         #####  #     #",
    "#  ################  #####  ##################  #",
    "#  #                                            #",
    "#################################################"
};

// =============================================================
//  SETUP NCURSES
// =============================================================
void setupNcurses() { // Fungsi untuk menginisialisasi library ncurses
    initscr();              // Inisialisasi ncurses
    cbreak();               // Disable line buffering
    noecho();               // Tidak menampilkan input ke layar
    keypad(stdscr, TRUE);   // Aktifkan input keyboard special (arrow keys)
    curs_set(0);            // Sembunyikan cursor

    if (has_colors()) {
        start_color();
        // Definisi warna: init_pair(id, warna_text, warna_background)
        init_pair(PAIR_BORDER, COLOR_WHITE, COLOR_BLACK);      // border putih
        init_pair(PAIR_WALL, COLOR_BLUE, COLOR_BLUE);          // tembok biru solid
        init_pair(PAIR_PATH, COLOR_BLACK, COLOR_BLACK);        // jalan hitam solid
        init_pair(PAIR_START_END, COLOR_YELLOW, COLOR_BLACK);  // Star/End kuning
        init_pair(PAIR_PLAYER, COLOR_RED, COLOR_BLACK);        // player merah
        init_pair(PAIR_MENU, COLOR_GREEN, COLOR_BLACK);        // menu hijau
        init_pair(PAIR_INFO, COLOR_CYAN, COLOR_BLACK);         // Info cyan
        init_pair(PAIR_WIN, COLOR_BLACK, COLOR_GREEN);         // win screen
    }
}
// Fungsi untuk membersihkan dan menutup ncurses
void cleanupNcurses() {
    endwin(); // Kembalikan terminal ke mode normal
}

// =============================================================
//  FIND START
// =============================================================
//mencari posisi titik star (S) di dalam maza
Position findStart(char maze[MAZE_ROWS][MAZE_COLS]) {
    for (int i = 0; i < MAZE_ROWS; ++i)
        for (int j = 0; j < MAZE_COLS - 1; ++j)
            if (maze[i][j] == 'S')
                return {i, j};
    return {-1, -1};
}

// =============================================================
//  DRAW MAZE
// =============================================================
//  Fungsi untuk menggambar maze di layar
void drawMaze(char maze[MAZE_ROWS][MAZE_COLS], const Position& playerPos,
              const string& levelName, int moves, int score)
{
    clear(); // bersihkan
    int startY = 1;
    // ===== GAMBAR BORDER LUAR =====
    attron(COLOR_PAIR(PAIR_BORDER) | A_BOLD);
    // Border atas dan bawah
    mvprintw(startY - 1, 0, "+");
    for (int j = 1; j < MAZE_COLS; ++j) {
        mvprintw(startY - 1, j, "-");         // border atas
        mvprintw(MAZE_ROWS + startY, j, "-"); // border bawah
    }
    mvprintw(startY - 1, MAZE_COLS, "+");
    mvprintw(MAZE_ROWS + startY, MAZE_COLS, "+");
    for (int i = 0; i < MAZE_ROWS; ++i) {
        mvprintw(i + startY, 0, "|");         //border kiri
        mvprintw(i + startY, MAZE_COLS, "|"); // border kanan
    }
    attroff(COLOR_PAIR(PAIR_BORDER) | A_BOLD);

    // ===== GAMBAR ISI MAZE =====
    for (int i = 0; i < MAZE_ROWS; ++i) {
        for (int j = 0; j < MAZE_COLS - 1; ++j) {
            char cell = maze[i][j];
            int pairId = PAIR_PATH;   //warna hitam jalan

            // Tentukan warna berdasarkan isi cell
            if (cell == '#') {
                pairId = PAIR_WALL;  // tembok biru
            } else if (cell == 'S' || cell == 'F') {
                pairId = PAIR_START_END;  // star dan finis kuning
            }

            attron(COLOR_PAIR(pairId));
            // Render cell sesuai tipe
            if (cell == '#') {
                mvaddch(i + startY, j + 1, ' '); // tembok
            } else if (cell == 'S') {
                mvaddch(i + startY, j + 1, 'S'); // star 
            } else if (cell == 'F') {
                mvaddch(i + startY, j + 1, 'F'); // finis
            } else {
                mvaddch(i + startY, j + 1, ' '); // jalan 
            }
            attroff(COLOR_PAIR(pairId));
        }
    }

    // ===== GAMBAR PLAYER =====
    attron(COLOR_PAIR(PAIR_PLAYER) | A_BOLD);
    mvaddch(playerPos.row + startY, playerPos.col + 1, 'O'); // player (merah)
    attroff(COLOR_PAIR(PAIR_PLAYER) | A_BOLD);

    // ===== TAMPILKAN INFO GAME =====
    attron(COLOR_PAIR(PAIR_INFO) | A_BOLD);
    mvprintw(MAZE_ROWS + startY + 2, 2, ">>> MAZE GAME | Level: %s <<<", levelName.c_str());
    mvprintw(MAZE_ROWS + startY + 2, MAZE_COLS - 25, "Langkah: %d | Skor: %d", moves, score);
    attroff(COLOR_PAIR(PAIR_INFO) | A_BOLD);

    // ===== TAMPILKAN INSTRUKSI =====
    attron(COLOR_PAIR(PAIR_MENU));
    mvprintw(MAZE_ROWS + startY + 3, 2, "Navigasi: Tombol Panah | S: Mulai, F: Selesai");
    mvprintw(MAZE_ROWS + startY + 4, 2, "Tekan 'M' untuk kembali ke Menu, 'Q' untuk Keluar.");
    attroff(COLOR_PAIR(PAIR_MENU));

    refresh(); // update layar
}

// =============================================================
//  RUN GAME
// =============================================================
bool runGame(char maze[MAZE_ROWS][MAZE_COLS], const string& levelName) {
    Position playerPos = findStart(maze);
    if (playerPos.row == -1) return true;

    int ch, nextRow, nextCol;
    int moveCount = 0;

    // ===== SCORE YANG DITENTUKAN =====
    int scoreInit = 10000;
    if (levelName == "Very Easy") scoreInit = 1300;
    else if (levelName == "Easy") scoreInit = 800;
    else if (levelName == "Medium") scoreInit = 900;
    else if (levelName == "Hard") scoreInit = 750;
    else if (levelName == "Very Hard") scoreInit = 1000;

    int score = scoreInit;

    while (true) {
        drawMaze(maze, playerPos, levelName, moveCount, score);
        ch = getch();

        if (ch == 'q' || ch == 'Q') return false;
        if (ch == 'm' || ch == 'M') return true;

        nextRow = playerPos.row;
        nextCol = playerPos.col;
        bool moved = false;

        if (ch == KEY_UP)    { nextRow--; moved = true; }
        if (ch == KEY_DOWN)  { nextRow++; moved = true; }
        if (ch == KEY_LEFT)  { nextCol--; moved = true; }
        if (ch == KEY_RIGHT) { nextCol++; moved = true; }

        if (moved && nextRow >= 0 && nextCol >= 0 &&
            nextRow < MAZE_ROWS && nextCol < MAZE_COLS - 1)
        {
            char nextCell = maze[nextRow][nextCol];

            if (nextCell != '#') {
                playerPos = { nextRow, nextCol };
                moveCount++;
                score = max(0, score - 5);
            }

            if (nextCell == 'F') {
                int finalScore = score + (1000 / max(1, moveCount));
                if (finalScore < 0) finalScore = 0;

                drawMaze(maze, playerPos, levelName, moveCount, finalScore);

                // === WIN SCREEN ===
                clear();

                int boxW = 50;
                int boxH = 12;
                int startY = (LINES - boxH) / 2;
                int startX = (COLS - boxW) / 2;

                // Box border
                attron(COLOR_PAIR(PAIR_BORDER) | A_BOLD);
                for (int i = 0; i < boxH; i++) {
                    for (int j = 0; j < boxW; j++) {
                        if (i == 0 && j == 0) mvaddch(startY + i, startX + j, '+');
                        else if (i == 0 && j == boxW - 1) mvaddch(startY + i, startX + j, '+');
                        else if (i == boxH - 1 && j == 0) mvaddch(startY + i, startX + j, '+');
                        else if (i == boxH - 1 && j == boxW - 1) mvaddch(startY + i, startX + j, '+');
                        else if (i == 0 || i == boxH - 1) mvaddch(startY + i, startX + j, '-');
                        else if (j == 0 || j == boxW - 1) mvaddch(startY + i, startX + j, '|');
                    }
                }
                attroff(COLOR_PAIR(PAIR_BORDER) | A_BOLD);

                // Judul menang
                attron(COLOR_PAIR(PAIR_WIN) | A_BOLD);
                mvprintw(startY + 2, startX + 12, "*** ANDA MENANG! ***");
                attroff(COLOR_PAIR(PAIR_WIN) | A_BOLD);

                // Informasi score
                attron(COLOR_PAIR(PAIR_INFO));
                mvprintw(startY + 4, startX + 5, "Total Langkah : %d", moveCount);
                mvprintw(startY + 5, startX + 5, "Final Score   : %d", finalScore);
                attroff(COLOR_PAIR(PAIR_INFO));

                // Garis pemisah
                attron(COLOR_PAIR(PAIR_BORDER));
                mvprintw(startY + 6, startX + 2, "----------------------------------------------");
                attroff(COLOR_PAIR(PAIR_BORDER));

                // Menu pilihan
                attron(COLOR_PAIR(PAIR_MENU));
                mvprintw(startY + 8, startX + 5, "1. Main lagi level ini");
                mvprintw(startY + 9, startX + 5, "2. Kembali ke Menu Utama");
                mvprintw(startY + 10, startX + 5, "3. Keluar Game");
                attroff(COLOR_PAIR(PAIR_MENU));

                refresh();

                int pilih;
                while (true) {
                    pilih = getch();
                    if (pilih == '1') {
                        return runGame(maze, levelName);
                    }
                    else if (pilih == '2') {
                        return true;
                    }
                    else if (pilih == '3') {
                        return false;
                    }
                }
            }
        }
    }

    return true;
}

// =============================================================
//  MENU
// =============================================================
// menampilakn menu utama dan memilih level
int showMenu() {
    int choice = 1; // Default pilihan pertama
    int key;

    while (true) {
        clear(); // Posisi tengah horizontal
        
        int centerX = COLS / 2;  // Posisi tengah horizontal
        int startY = 2;

        // ===== ASCII ART TITLE =====
        attron(COLOR_PAIR(PAIR_MENU) | A_BOLD);
        mvprintw(startY    , centerX - 23, " ¦¦¦¦¦     ¦¦¦    ¦¦¦  ¦¦¦¦¦  ¦¦¦¦¦¦¦ ¦¦¦¦¦¦¦");
        mvprintw(startY + 1, centerX - 23, "¦¦   ¦¦    ¦¦¦¦  ¦¦¦¦ ¦¦   ¦¦    ¦¦¦  ¦¦     ");
        mvprintw(startY + 2, centerX - 23, "¦¦¦¦¦¦¦ -- ¦¦ ¦¦¦¦ ¦¦ ¦¦¦¦¦¦¦   ¦¦¦   ¦¦¦¦¦  ");
        mvprintw(startY + 3, centerX - 23, "¦¦   ¦¦    ¦¦  ¦¦  ¦¦ ¦¦   ¦¦  ¦¦¦    ¦¦     ");
        mvprintw(startY + 4, centerX - 23, "¦¦   ¦¦    ¦¦      ¦¦ ¦¦   ¦¦ ¦¦¦¦¦¦¦ ¦¦¦¦¦¦¦");
        attroff(COLOR_PAIR(PAIR_MENU) | A_BOLD);
        
        // ===== SUBTITLE =====
        attron(COLOR_PAIR(PAIR_INFO));
        mvprintw(startY + 6, centerX - 11, "-- ADVENTURE AWAITS --");
        attroff(COLOR_PAIR(PAIR_INFO));

        // ===== BOX HEADER =====
        attron(COLOR_PAIR(PAIR_BORDER));
        mvprintw(startY + 8, centerX - 13, "+---------------------------+");
        mvprintw(startY + 9, centerX - 13, "|    SELECT YOUR LEVEL      |");
        mvprintw(startY + 10, centerX - 13, "+---------------------------+");
        attroff(COLOR_PAIR(PAIR_BORDER));

        // ===== DAFTAR LEVEL =====
        const char* levels[] = {
            "Level 1 (Very Easy)",
            "Level 2 (Easy)",
            "Level 3 (Medium)",
            "Level 4 (Hard)",
            "Level 5 (Very Hard)",
            "Keluar Program (Q)"
        };

        // Tampilkan setiap opsi menu
        for (int i = 1; i <= 6; i++) {
            // Highlight pilihan yang sedang aktif
            if (choice == i) {
                attron(COLOR_PAIR(PAIR_MENU) | A_REVERSE | A_BOLD);
                mvprintw(startY + 11 + i, centerX - 12, " %d. %-22s ", i, levels[i-1]);
                attroff(COLOR_PAIR(PAIR_MENU) | A_REVERSE | A_BOLD);
            } else {
                attron(COLOR_PAIR(PAIR_MENU));
                mvprintw(startY + 11 + i, centerX - 12, " %d. %-22s ", i, levels[i-1]);
                attroff(COLOR_PAIR(PAIR_MENU));
            }
        }

        // ===== BOTTOM BORDER =====
        attron(COLOR_PAIR(PAIR_BORDER));
        mvprintw(startY + 19, centerX - 20, "==========================================");
        attroff(COLOR_PAIR(PAIR_BORDER));
        
        // ===== INSTRUKSI =====
        attron(COLOR_PAIR(PAIR_INFO));
        mvprintw(startY + 20, centerX - 19, "Arrow Navigate | ENTER Select | Q Quit");
        attroff(COLOR_PAIR(PAIR_INFO));

        refresh();  // Update layar
        
        // Terima input dari keyboard
        key = getch();

        // Proses input
        if (key == KEY_UP && choice > 1) {
            choice--;  // Pindah ke atas
        }
        else if (key == KEY_DOWN && choice < 6) {
            choice++;  // Pindah ke bawah
        }
        else if (key == 10) {  // Enter key (ASCII 10)
            return choice;     // Return pilihan
        }
        else if (key == 'q' || key == 'Q') {
            return 6;  // Keluar program
        }
    }
}

// =============================================================
//  MAIN PROGRAM
// =============================================================
int main() {
// inisialisai ncruses dan setup warna
    setupNcurses();

    bool running = true; // flag untuk mengatur loop utama
    // ===== LOOP UTAMA PROGRAM =====
    while (running) {
        // Tampilkan menu dan dapatkan pilihan user (1-6)
        int level = showMenu();
        bool cont = true;  // Flag untuk kontrol flow

        // Jalankan game sesuai level yang dipilih
        // Setiap level memiliki maze dan nama difficulty yang berbeda
        if (level == 1) cont = runGame(mazeVeryEasy, "Very Easy");
        else if (level == 2) cont = runGame(mazeEasy, "Easy");
        else if (level == 3) cont = runGame(mazeMedium, "Medium");
        else if (level == 4) cont = runGame(mazeHard, "Hard");
        else if (level == 5) cont = runGame(mazeVeryHard, "Very Hard");
            // Pilihan 6 atau 'Q': Keluar program
            running = false;
        // Jika runGame() return false, user ingin keluar
        if (!cont) running = false;
    }

    cleanupNcurses();      // Bersihkan ncurses dan kembalikan terminal ke mode normal
    return 0;  // Program selesai
}
